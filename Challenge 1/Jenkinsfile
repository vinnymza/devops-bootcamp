def PASSWORD 
pipeline {
    agent any
    parameters {
        string(name: 'LOGIN', defaultValue: '', description: 'Unique user identifier. Usually name and lastname')
        string(name: 'NAME_LASTNAME', defaultValue: '', description: 'User Name and Lastname')
        choice(name: 'GROUP_DEPARTMENT', choices: ['Contabilidad', 'Finanzas', 'Tecnologia'], description: '')
    }
    stages {
        stage('Create User') {
            steps {
                script{
                    echo "Creating user with temporal password for ${params.NAME_LASTNAME}"
                    sh(script: "sudo useradd -m ${params.LOGIN}", returnStdout: true).trim()
                }
            }
        }
        stage('Add Password') {
            steps {
                script{
                    PASSWORD = sh(script: 'tr -dc A-Za-z0-9 </dev/urandom | head -c 13; echo', returnStdout: true).trim()
                    sh "echo ${PASSWORD} | sudo passwd --stdin ${params.LOGIN}"
                    echo "Password created: ${PASSWORD}"
                    sh "sudo passwd -e ${params.LOGIN}"
                    echo "Password expirated, user must change password on next login"
                }
            }
        }
        stage('Add Group') {
            steps {
                script{
                    sh(script: "sudo usermod -aG ${params.GROUP_DEPARTMENT} ${params.LOGIN}", returnStdout: true).trim()
                    echo "Group added: ${GROUP_DEPARTMENT}"
                }
            }
        }
    }
}

